From 1d714aacd5eeb47898ad6f4ce31993e1671e8722 Mon Sep 17 00:00:00 2001
From: eumagga0x2a <eumagga0x2a@users.noreply.github.com>
Date: Mon, 25 Mar 2019 20:23:26 +0100
Subject: [PATCH] [ad_lav] Do not skip channel mapping on decoding error

---
 .../ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp           | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp b/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
index 21db257f8..cb69710b9 100644
--- a/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
+++ b/avidemux_plugins/ADM_audioDecoders/ADM_ad_lav/ADM_ad_lav.cpp
@@ -442,7 +442,8 @@ uint8_t ADM_AudiocoderLavcodec::run(uint8_t *inptr, uint32_t nbIn, float *outptr
     AVPacket pkt;
     av_init_packet(&pkt);
     int nbChunk,res=0;
-    while(_tail-_head>=_blockalign)
+    bool eof=false;
+    while(_tail-_head>=_blockalign && !eof)
     {
         nbChunk=(_tail-_head)/_blockalign;
         pkt.size=nbChunk*_blockalign;
@@ -458,14 +459,15 @@ uint8_t ADM_AudiocoderLavcodec::run(uint8_t *inptr, uint32_t nbIn, float *outptr
             if(res==AVERROR(EAGAIN)) break; // we need to send more input
             if(res==AVERROR_EOF)
             {
-                return 1;
+                eof=true;
+                break;
             }
             if(res<0)
             {
                 char er[2048]={0};
                 av_make_error_string(er, sizeof(er)-1, res);
                 ADM_warning("[ADM_ad_lav] decoding error: %s\n",er);
-                return 1;
+                break;
             }
 
             bool invalid=false;
